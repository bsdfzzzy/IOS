{% extends "admin_manage/layout.html" %}
{% block script-front %}
  <link href="/static/css/theme.default.min.css" rel="stylesheet">
  <script src="/static/js/jquery.tablesorter.min.js"></script>
  <script src="/static/js/jquery.tablesorter.widgets.min.js"></script>
  <script type="text/javascript">
    $(function(){
      $('table').tablesorter({
        widgets        : ['zebra', 'columns'],
        usNumberFormat : false,
        sortReset      : true,
        sortRestart    : true
      });
    });
  </script>
{% endblock %}
{% block nav %}
  <div class="templatemo-top-nav-container" style="padding-top:10px;">
          <div class="row">
            <nav class="templatemo-top-nav col-lg-12 col-md-12" style="margin-top:10px;" id="check-address">
              注册地：<span data-id="1">北京市</span> 　<span data-id="2">广东省</span> 　<span data-id="3">山东省</span> 　<span data-id="4">江苏省</span> 　<span data-id="5">河南省</span> 　<span data-id="6">上海市</span> 　<span data-id="7">河北省</span> 　<span data-id="8">浙江省</span> 　<span data-id="9">香港区</span> 　<span data-id="10">陕西省</span> 　<span data-id="11">湖南省</span> 　<span data-id="12">重庆市</span> 　<span data-id="13">福建省</span> 　<span data-id="14">天津市</span> 　<span data-id="15">云南省</span> 　<span data-id="16">四川省</span> 　<span data-id="17">广西省</span> 　<span data-id="18">安徽省</span> 　<span data-id="19">海南省</span> 　<span data-id="20">江西省</span> 　<span data-id="21">湖北省</span> 　<span data-id="22">山西省</span> 　<span data-id="23">辽宁省</span> 　<span data-id="24">台湾省</span> 　<span data-id="25">黑龙江</span> 　<span data-id="26">内蒙古</span> 　<span data-id="27">澳门区</span> 　<span data-id="28">贵州省</span> 　<span data-id="29">甘肃省</span> 　<span data-id="30">青海省</span> 　<span data-id="31">新疆区</span> 　<span data-id="32">西藏区</span> 　<span data-id="33">吉林省</span> 　<span data-id="34">宁夏区</span>     <span data-id="35">海外</span>
            </nav>
            <nav class="templatemo-top-nav col-lg-12 col-md-12" style="margin-top:10px;">
              注册时间：
              <div id="year" style="display:inline-block"><select class="year">
                <option value="0">所有</option>
                <option value="2016">2016</option>
                <option value="2017">2017</option>
                <option value="2018">2018</option>
                <option value="2019">2019</option>
                <option value="2020">2020</option>
              </select>年</div>
              <div id="month" style="display:inline-block;"><select class="month">
                <option value="0">所有</option>
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4">4</option>
                <option value="5">5</option>
                <option value="6">6</option>
                <option value="7">7</option>
                <option value="8">8</option>
                <option value="9">9</option>
                <option value="10">10</option>
                <option value="11">11</option>
                <option value="12">12</option>
              </select>月</div>
              <div id="day" style="display:inline-block;"><select class="day">
                <option value="0">所有</option>
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4">4</option>
                <option value="5">5</option>
                <option value="6">6</option>
                <option value="7">7</option>
                <option value="8">8</option>
                <option value="9">9</option>
                <option value="10">10</option>
                <option value="11">11</option>
                <option value="12">12</option>
                <option value="13">13</option>
                <option value="14">14</option>
                <option value="15">15</option>
                <option value="16">16</option>
                <option value="17">17</option>
                <option value="18">18</option>
                <option value="19">19</option>
                <option value="20">20</option>
                <option value="21">21</option>
                <option value="22">22</option>
                <option value="23">23</option>
                <option value="24">24</option>
                <option value="25">25</option>
                <option value="26">26</option>
                <option value="27">27</option>
                <option value="28">28</option>
                <option value="29">29</option>
                <option value="30">30</option>
                <option value="31">31</option>
              </select>日</div>
              <span style="margin-left:10px;" id="confirm">确认</span>
            </nav>
            <nav class="templatemo-top-nav col-lg-12 col-md-12" style="margin-top:10px;" id="check-event">
              最近七天日程量：    <span data-id="0">0条</span>        <span data-id="1">1条</span>       <span data-id="2">2-5条</span>        <span data-id="3">6-10条</span>        <span data-id="4">10-20条</span>        <span data-id="5">20条以上</span>
            </nav>
            <nav class="templatemo-top-nav col-lg-12 col-md-12" style="margin-top:10px;" id="more-terms">
              已选条件：
            </nav>
            <button class="btn btn-info btn-flat" style="margin-left:10px;margin-top:20px;" id="submit">提交筛选</button>
          </div>
  </div>
{% endblock %}
{% block content %}
<div class="templatemo-flex-row flex-content-row">
            <div class="col-1">
              <div class="panel panel-default templatemo-content-widget white-bg no-padding templatemo-overflow-hidden">
                <div class="panel-heading templatemo-position-relative">
                  <h2 class="text-uppercase">用户列表</h2>
                </div>
                <div class="table-responsive">
                  <table class="table table-striped table-bordered">
                    <thead>
                      <tr>
                        <td>No.</td>
                        <td>用户名</td>
                        <td>邮箱</td>
                        <td>手机</td>
                        <td>注册地</td>
                        <td>注册时间</td>
                        <td>最后活跃时间</td>
                        <td>累计日程数量</td>
                        <td>最近七天日程数量</td>
                      </tr>
                    </thead>
                    <tbody>
                    {% for user in users %}
                      <tr>
                        <td class="user_id">{{user.id}}</td>
                        <td class="user_name">{% if admin.admin_type == '1' %}<a href="/admin_manage/users/{{user.id}}">{{user.name}}</a>{% else %}{{user.name}}{% endif %}</td>
                        <td>{{user.email}}</td>
                        <td>{{user.phone}}</td>
                        <td></td>
                        <td class="user_time">{{user.create_time}}</td>
                        <td>{{user.last_update}}</td>
                        <td>{{user.all_events_num}}</td>
                        <td>{{user.recent_seven_days_events_num}}</td>
                      </tr>
                    {% endfor %} 
                    </tbody>
                  </table>    
                </div>                          
              </div>
            </div>           
          </div>
  {% endblock %}
  {% block script %}
  <script type="text/javascript">
  $(document).ready(function(){
    $('.month').bind('change', function(){
      if ($('.month').val() == 1 || $('.month').val() == 3 || $('.month').val() == 5 || $('.month').val() == 7 || $('.month').val() == 8 || $('.month').val() == 10 || $('.month').val() == 12){
        $('#day').css('display', 'inline-block');
        $('.day option[value="29"], .day option[value="30"], .day option[value="31"]').css('display', 'block');
      }else if($('.month').val() == 2){
        if ($('.year').val() == 2016 || $('.year').val() == 2020){
          $('#day').css('display', 'inline-block');
          $('.day option[value="29"]').css('display', 'block');
          $('.day option[value="30"], .day option[value="31"]').css('display', 'none');
        }else{
          $('#day').css('display', 'inline-block');
          $('.day option[value="29"], .day option[value="30"], .day option[value="31"]').css('display', 'none');
        }
      }else{
        $('.day option[value="29"], .day option[value="30"]').css('display', 'block');
        $('.day option[value="31"]').css('display', 'none');
      }
    });
    $('#check-address span').bind('click', function(){
      var id = $(this).data('id');
      var address = $(this).html();
      if($(this).css("color") == 'rgb(51, 51, 51)'){
        $(this).css('color','#39ADB4');
        var li = '<i class="find-address' + id + ' find-address" data-id="' + id + '">' + address + '</i>';
        $('#more-terms').append(li);
      }else{
        $(this).css('color','#333333');
        $('#more-terms .find-address'+ id +'').remove();
      }
    });
    $('#confirm').bind('click', function(){
      var year = $('.year').val();
      var month = $('.month').val();
      var day = $('.day').val();
      var year_, month_, day_;
      if (year == 0){
        year_ = '所有';
      }else{
        year_ = year;
      }
      if (month == 0){
        month_ = '所有';
      }else{
        month_ = month;
      }
      if (day == 0){
        day_ = '所有';
      }else{
        day_ = day;
      }
      var li = '<i class="find-date" data-id="'+year+'-'+month+'-'+day+'">'+ year_ + '年' + month_ + '月' + day_ + '日 ' +'</i>'
      if($('#more-terms i').hasClass('find-date')){
        showFailAlert('已有选择日期');
      }else{
        $('#more-terms').append(li);
      }
    });
    $('#more-terms find-date').bind('click',function(){
      $(this).remove();
    });
    $('#check-event span').bind('click', function(){
      var id = $(this).data('id');
      var event_num = $(this).html();
      if($(this).css("color") == 'rgb(51, 51, 51)'){
        $(this).css('color','#39ADB4');
        var li = '<i class="find-event' + id + ' find-event" data-id="'+ id +'">' + event_num + '</i>';
        $('#more-terms').append(li);
      }else{
        $(this).css('color','#333333');
        $('#more-terms .find-event'+id+'').remove();
      }
    });
    $('#submit').bind('click', function(){
      var address_ids = [];
      var event_ids = [];
      var date = {};
      for (var i=0; i<$('#more-terms i').length;i++){
        if($('#more-terms i').eq(i).hasClass('find-address')){
          address_ids.push($('#more-terms i').eq(i).data('id'));
        }else if($('#more-terms i').eq(i).hasClass('find-event')){
          event_ids.push($('#more-terms i').eq(i).data('id'));
        }else{
          var arr = $('#more-terms .find-date').data('id').split('-');
          date = {'year':arr[0], 'month':arr[1], 'day':arr[2]};
        }
      }
      $.ajax({
        method:"POST",
        url:"/admin_manage/filter_user",
        contentType:"application/json",
        data:JSON.stringify({
          addresses:address_ids,
          events:event_ids,
          date:date
        }),
        success:function(res){
          $('tbody').empty();
          console.log(res.users);
          for(var i = 0;i < res.users.length; i++){
            var tr = '<tr><td>'+ users[i].id +'</td><td>{% if admin.admin_type == '1' %}<a href="/admin_manage/users/'+ users[i].id +'">'+ users[i].name +'</a>{% else %}' + users[i].name +'{% endif %}</td><td>'+ users[i].email +'</td><td>'+ users[i].phone +'</td><td>'+ users[i].create_time +'</td><td>'+ users[i].last_update +'</td><td>'+ users[i].all_events_num +'</td><td>'+ users[i].recent_seven_days_events_num +'</td></tr>';
            $('tbody').append(tr);
          }
        }
      });
    });
  });
  function order_by_letter(){
    if ($('.letter_').html() == '升'){
      $('.letter_').html('降');
    }else{
      $('.letter_').html('升');
    }
    $.ajax({
      method:"POST",
      url:"/admin_manage/order_by_letter",
      contentType:"application/json",
      data:JSON.stringify({
        term:'letter'
      })
    });
  }
  function order_by_number(){
    if ($('.number_').html() == '升'){
      $('.number_').html('降');
    }else{
      $('.number_').html('升');
    }
    $.ajax({
      method:"POST",
      url:"/admin_manage/order_by_number",
      contentType:"application/json",
      data:JSON.stringify({
        term:'number'
      })
    });
  }
  function order_by_time(){
    if ($('.time_').html() == '升'){
      $('.time_').html('降');
    }else{
      $('.time_').html('升');
    }
    $.ajax({
      method:"POST",
      url:"/admin_manage/order_by_time",
      contentType:"application/json",
      data:JSON.stringify({
        term:'time'
      })
    });
  }
  </script>
  {% endblock %}