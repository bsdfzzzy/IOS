{% extends "admin_manage/layout.html" %}
{% block script-front %}
  <link href="/static/css/theme.default.min.css" rel="stylesheet">
  <script src="/static/js/jquery.tablesorter.min.js"></script>
  <script src="/static/js/jquery.tablesorter.widgets.min.js"></script>
  <script type="text/javascript">
    $(function(){
      $('table').tablesorter({
        widgets        : ['zebra', 'columns'],
        usNumberFormat : false,
        sortReset      : true,
        sortRestart    : true
      });
    });
  </script>
{% endblock %}
{% block nav %}
  <div class="templatemo-top-nav-container">
          <div class="row">
            <nav class="templatemo-top-nav col-lg-12 col-md-12">
              <ul class="text-uppercase">
                <li><a href="/admin_manage/recommends" class="check_list active">查看列表</a></li>
                <li><a href="javascript:void(0)" class="new_event" data-toggle="modal" data-target="#add_event_modal">新建日程</a></li>
              </ul>  
            </nav> 
          </div>
  </div>
  <div class="templatemo-top-nav-container" style="padding-top:10px;">
    <div class="row">
        <nav class="templatemo-top-nav col-lg-12 col-md-12" style="margin-top:10px;" id="check-address">
              日程地：<span data-id="1">北京市</span> 　<span data-id="2">广东省</span> 　<span data-id="3">山东省</span> 　<span data-id="4">江苏省</span> 　<span data-id="5">河南省</span> 　<span data-id="6">上海市</span> 　<span data-id="7">河北省</span> 　<span data-id="8">浙江省</span> 　<span data-id="9">香港区</span> 　<span data-id="10">陕西省</span> 　<span data-id="11">湖南省</span> 　<span data-id="12">重庆市</span> 　<span data-id="13">福建省</span> 　<span data-id="14">天津市</span> 　<span data-id="15">云南省</span> 　<span data-id="16">四川省</span> 　<span data-id="17">广西省</span> 　<span data-id="18">安徽省</span> 　<span data-id="19">海南省</span> 　<span data-id="20">江西省</span> 　<span data-id="21">湖北省</span> 　<span data-id="22">山西省</span> 　<span data-id="23">辽宁省</span> 　<span data-id="24">台湾省</span> 　<span data-id="25">黑龙江</span> 　<span data-id="26">内蒙古</span> 　<span data-id="27">澳门区</span> 　<span data-id="28">贵州省</span> 　<span data-id="29">甘肃省</span> 　<span data-id="30">青海省</span> 　<span data-id="31">新疆区</span> 　<span data-id="32">西藏区</span> 　<span data-id="33">吉林省</span> 　<span data-id="34">宁夏区</span>     <span data-id="35">海外</span>
            </nav>
            <nav class="templatemo-top-nav col-lg-12 col-md-12" style="margin-top:10px;">
              开始时间：
              <div id="year" style="display:inline-block"><select class="year">
                <option value="0">所有</option>
                <option value="2016">2016</option>
                <option value="2017">2017</option>
                <option value="2018">2018</option>
                <option value="2019">2019</option>
                <option value="2020">2020</option>
              </select>年</div>
              <div id="month" style="display:inline-block;"><select class="month">
                <option value="0">所有</option>
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4">4</option>
                <option value="5">5</option>
                <option value="6">6</option>
                <option value="7">7</option>
                <option value="8">8</option>
                <option value="9">9</option>
                <option value="10">10</option>
                <option value="11">11</option>
                <option value="12">12</option>
              </select>月</div>
              <div id="day" style="display:inline-block;"><select class="day">
                <option value="0">所有</option>
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4">4</option>
                <option value="5">5</option>
                <option value="6">6</option>
                <option value="7">7</option>
                <option value="8">8</option>
                <option value="9">9</option>
                <option value="10">10</option>
                <option value="11">11</option>
                <option value="12">12</option>
                <option value="13">13</option>
                <option value="14">14</option>
                <option value="15">15</option>
                <option value="16">16</option>
                <option value="17">17</option>
                <option value="18">18</option>
                <option value="19">19</option>
                <option value="20">20</option>
                <option value="21">21</option>
                <option value="22">22</option>
                <option value="23">23</option>
                <option value="24">24</option>
                <option value="25">25</option>
                <option value="26">26</option>
                <option value="27">27</option>
                <option value="28">28</option>
                <option value="29">29</option>
                <option value="30">30</option>
                <option value="31">31</option>
              </select>日</div>
              <span style="margin-left:10px;" id="confirm">确认</span>
            </nav>
            <nav class="templatemo-top-nav col-lg-12 col-md-12" style="margin-top:10px;" id="check-category">
              日程类别：<span data-id="1">工作</span> 　<span data-id="2">家庭</span> 　<span data-id="3">学习</span> 　<span data-id="4">运动</span> 　<span data-id="5">旅行</span> 　<span data-id="6">娱乐</span> 　<span data-id="7">待办</span> 　<span data-id="8">假日</span> 　<span data-id="9">纪念日</span> 　<span data-id="10">其他</span>
            </nav>
            <nav class="templatemo-top-nav col-lg-12 col-md-12" style="margin-top:10px;" id="check-source">
              日程来源：<span data-id="1">网络</span> 　<span data-id="2">人工</span> 　<span data-id="3">广告</span>
            </nav>
            <nav class="templatemo-top-nav col-lg-12 col-md-12" style="margin-top:10px;" id="more-terms">
              已选条件：
            </nav>
            <button class="btn btn-info btn-flat" style="margin-left:10px;margin-top:20px;" id="submit">提交筛选</button>
    </div>
  </div>
{% endblock %}
{% block content %}
<div class="templatemo-flex-row flex-content-row">
            <div class="col-1">
              <div class="panel panel-default templatemo-content-widget white-bg no-padding templatemo-overflow-hidden">
                <div class="panel-heading templatemo-position-relative"><h2 class="text-uppercase">日程列表</h2></div>
                <div class="table-responsive">
                  <table class="table table-striped table-bordered">
                    <thead>
                      <tr>
                        <td>日程主题</td>
                        <td>日程时间</td>
                        <td>日程地点</td>
                        <td>日程来源</td>
                        <td>上传时间</td>
                        <td>最近更新时间</td>
                        <td>发布状态</td>
                        <td>发布时间</td>
                        <td>发布管理员</td>
                        <td>审核状态</td>
                        <td>审核时间</td>
                        <td>审核管理员</td>
                      </tr>
                    </thead>
                    <tbody>
                    {% for recommend in recommends %}
                      <tr>
                        <td><a href="javascript:void(0)" data-toggle="modal" data-id="{{recommend.id}}" data-target="#recommend_event_{{recommend.id}}" class="recommend_title">{{recommend.title}}</a></td>
                        <td>{{recommend.start_time}}</td>
                        <td>{{recommend.address}}</td>
                        <td>{{recommend.source.name}}</td>
                        <td>{{recommend.create_time}}</td>
                        <td>{{recommend.last_update}}</td>
                        <td>{% if recommend.publish_state == '0' %}未发布{% else %}已发布{% endif %}</td>
                        <td>{{recommend.create_time}}</td>
                        <td>{{recommend.publish_name}}</td>
                        <td>{% if recommend.check_state == '0' %}未审核{% else %}已审核{% endif %}</td>
                        <td>{{recommend.check_time}}</td>
                        <td>{{recommend.check_name}}</td>
                      </tr>
                    {% endfor %} 
                    </tbody>
                  </table>    
                </div>                          
              </div>
            </div>           
          </div>
          <div class="modal fade" id="add_event_modal">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
                            aria-hidden="true">×</span></button>
                    <h4 class="modal-title">新建日程</h4>
                </div>
                <div class="modal-body">
                    <form class="form-horizontal">
                        <div class="form-group">
                            <label for="title" class="col-sm-2 control-label">日程主题</label>
                            <div class="col-sm-10">
                                <input type="text" class="form-control" id="title" placeholder="">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="start_time" class="col-sm-2 control-label">起始时间</label>
                            <div class="col-sm-10">
                                <input type="date" class="form-control" id="start_time"
                                       placeholder="">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="end_time" class="col-sm-2 control-label">终止时间</label>
                            <div class="col-sm-10">
                                <input type="date" class="form-control" id="end_time"
                                       placeholder="">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="address" class="col-sm-2 control-label">地点</label>
                            <div class="col-sm-10">
                                <input type="text" class="form-control" id="address"
                                       placeholder="">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="password" class="col-sm-2 control-label">日程内容</label>
                            <div class="col-sm-10">
                                <input type="text" class="form-control" id="content"
                                       placeholder="">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="category" class="col-sm-2 control-label">日程类型</label>
                            <div class="col-sm-10">
                                <select id="category">
                                    <option value="1">工作</option>
                                    <option value="2">家庭</option>
                                    <option value="3">学习</option>
                                    <option value="4">运动</option>
                                    <option value="5">旅行</option>
                                    <option value="6">娱乐</option>
                                    <option value="7">待办</option>
                                    <option value="8">假日</option>
                                    <option value="9">纪念日</option>
                                    <option value="10">其他</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="pic_url" class="col-sm-2 control-label">上传图片</label>
                            <div class="col-sm-10">
                                <input type="file" class="form-control" id="pic_url"
                                       placeholder="">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="label" class="col-sm-2 control-label">日程标注</label>
                            <div class="col-sm-10">
                                <input type="text" class="form-control" id="label"
                                       placeholder="">
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default pull-left" data-dismiss="modal">关闭</button>
                    <button type="button" class="btn btn-primary" id="add_event">保存</button>
                </div>
            </div>
            <!-- /.modal-content -->
        </div>
        <!-- /.modal-dialog -->
    </div>
    {% for recommend in recommends %}
    <div class="modal fade model_event" id="recommend_event_{{recommend.id}}">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
                            aria-hidden="true">×</span></button>
                    <h4 class="modal-title"></h4>
                </div>
                <div class="modal-body">
                    <form class="form-horizontal">
                        <div class="form-group">
                            <label for="password" class="col-sm-2 control-label">起始时间</label>
                            <div class="col-sm-10">
                                <input type="text" class="form-control" id="recommend_start_time"
                                       value="{{recommend.start_time}}">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="password" class="col-sm-2 control-label">终止时间</label>
                            <div class="col-sm-10">
                                <input type="text" class="form-control" id="recommend_end_time"
                                       value="{{recommend.end_time}}">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="password" class="col-sm-2 control-label">地点</label>
                            <div class="col-sm-10">
                                <input type="text" class="form-control" id="recommend_address"
                                       value="{{recommend.address}}">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="password" class="col-sm-2 control-label">日程内容</label>
                            <div class="col-sm-10">
                                <input type="text" class="form-control" id="recommend_content"
                                       value="{{recommend.content}}">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="password" class="col-sm-2 control-label">图片</label>
                            <div class="col-sm-10">
                                <img src="{{recommend.pic_url}}">
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default pull-left" data-dismiss="modal">关闭</button>
                    <button type="button" class="btn btn-primary" id="check_event" {% if recommend.check_state == "1" %}disabled{% endif %}>{% if recommend.check_state == "1" %}已审核{% else %}审核{% endif %}</button>
                    <button type="button" class="btn btn-primary" id="publish_event" {% if recommend.publish_state == "1" %}disabled{% endif %}>{% if recommend.publish_state == "1" %}已发布{% else %}发布{% endif %}</button>
                </div>
            </div>
            <!-- /.modal-content -->
        </div>
        <!-- /.modal-dialog -->
    </div>
    {% endfor %}
  {% endblock %}
  {% block script %}
    <script type="text/javascript">
    $(document).ready(function(){
        $('#add_event').bind('click', function(){
            var title = $('#title').val();
            var start_time = $('#start_time').val();
            var end_time = $('#end_time').val();
            var address = $('#address').val();
            var content = $('#content').val();
            var category = $('#category').val();
            var pic_url = $('#pic_url').val();
            var label = $('#label').val();
            $.ajax({
                method:"POST",
                url:"/admin_manage/recommends/add_event",
                contentType:'application/json',
                data:JSON.stringify({
                    title:title,
                    start_time:start_time,
                    end_time:end_time,
                    address:address,
                    content:content,
                    category:category,
                    pic_url:pic_url,
                    label:label
                }),
                success:function(res){
                    if(res.code==1){
                        showSuccessAlert('新建成功！');
                        setTimeout("window.location.reload()",1000);
                    }
                }
            })
        });
        var id;
        $('.recommend_title').bind('click', function(){
            id = $(this).data('id');
        });
        $('#check_event').bind('click', function(){
            $.ajax({
                method:"POST",
                url:"/admin_manage/recommends/check_event",
                contentType:'application/json',
                data:JSON.stringify({
                    id:id
                }),
                success:function(res){
                    if (res.code == 1){
                        showSuccessAlert('审核成功！');
                        setTimeout("window.location.reload()",1000);
                    }
                }
            });
        });
        $('#publish_event').bind('click', function(){
            $.ajax({
                method:"POST",
                url:"/admin_manage/recommends/publish_event",
                contentType:'application/json',
                data:JSON.stringify({
                    id:id
                }),
                success:function(res){
                    if (res.code == 1){
                        showSuccessAlert('发布成功！');
                        setTimeout("window.location.reload()",1000);
                    }
                }
            });
        });
        $('#start_search').bind('click', function(){
            search_term = $('#search_term').val();
            search_detail = $('#search_detail').val();
            $.ajax({
                method:"POST",
                url:"/admin_manage/recommends/search",
                contentType:'application/json',
                data:JSON.stringify({
                    search_term:search_term,
                    search_detail:search_detail
                })
            });
        });
        $('#check-address span').bind('click', function(){
            var id = $(this).data('id');
            var address = $(this).html();
            if($(this).css("color") == 'rgb(51, 51, 51)'){
                $(this).css('color','#39ADB4');
                var li = '<i class="find-address' + id + ' find-address" data-id="' + id + '">' + address + '</i>';
                $('#more-terms').append(li);
            }else{
                $(this).css('color','#333333');
                $('#more-terms .find-address'+ id +'').remove();
            }
        });
        $('#check-category span').bind('click', function(){
            var id = $(this).data('id');
            var category = $(this).html();
            if($(this).css("color") == 'rgb(51, 51, 51)'){
                $(this).css('color','#39ADB4');
                var li = '<i class="find-category' + id + ' find-category" data-id="' + id + '">' + category + '</i>';
                $('#more-terms').append(li);
            }else{
                $(this).css('color','#333333');
                $('#more-terms .find-category'+ id +'').remove();
            }
        });
        $('#check-source span').bind('click', function(){
            var id = $(this).data('id');
            var source = $(this).html();
            if($(this).css("color") == 'rgb(51, 51, 51)'){
                $(this).css('color','#39ADB4');
                var li = '<i class="find-source' + id + ' find-source" data-id="' + id + '">' + source + '</i>';
                $('#more-terms').append(li);
            }else{
                $(this).css('color','#333333');
                $('#more-terms .find-source'+ id +'').remove();
            }
        });
        $('#confirm').bind('click', function(){
            var year = $('.year').val();
            var month = $('.month').val();
            var day = $('.day').val();
            var year_, month_, day_;
            if (year == 0){
                year_ = '所有';
            }else{
                year_ = year;
            }
            if (month == 0){
                month_ = '所有';
            }else{
                month_ = month;
            }
            if (day == 0){
                day_ = '所有';
            }else{
                day_ = day;
            }
            var li = '<i class="find-date" data-id="'+year+'-'+month+'-'+day+'">'+ year_ + '年' + month_ + '月' + day_ + '日 ' +'</i>'
            if($('#more-terms i').hasClass('find-date')){
                showFailAlert('已有选择日期');
            }else{
                $('#more-terms').append(li);
            }
        });
        $('#submit').bind('click', function(){
            var address_ids = [];
            var category_ids = [];
            var source_ids = [];
            var date = {};
            for (var i=0; i<$('#more-terms i').length;i++){
                if($('#more-terms i').eq(i).hasClass('find-address')){
                    address_ids.push($('#more-terms i').eq(i).data('id'));
                }else if($('#more-terms i').eq(i).hasClass('find-category')){
                    category_ids.push($('#more-terms i').eq(i).data('id'));
                }else if($('#more-terms i').eq(i).hasClass('find-source')){
                    source_ids.push($('#more-terms i').eq(i).data('id'));
                }else{
                    var arr = $('#more-terms .find-date').data('id').split('-');
                    date = {'year':arr[0], 'month':arr[1], 'day':arr[2]};
                }
            }
            $.ajax({
                method:"POST",
                url:"/admin_manage/filter_recommend",
                contentType:"application/json",
                data:JSON.stringify({
                    addresses:address_ids,
                    categorys:category_ids,
                    sources:source_ids,
                    date:date
                }),
                success:function(res){
                    $('tbody').empty();
                    console.log(res.users);
                    for(var i = 0;i < res.users.length; i++){
                        var tr = '<tr><td>'+ users[i].id +'</td><td>{% if admin.admin_type == '1' %}<a href="/admin_manage/users/'+ users[i].id +'">'+ users[i].name +'</a>{% else %}' + users[i].name +'{% endif %}</td><td>'+ users[i].email +'</td><td>'+ users[i].phone +'</td><td>'+ users[i].create_time +'</td><td>'+ users[i].last_update +'</td><td>'+ users[i].all_events_num +'</td><td>'+ users[i].recent_seven_days_events_num +'</td></tr>';
                        $('tbody').append(tr);
                    }
                }
            });
        });
    });
    </script>
  {% endblock %}